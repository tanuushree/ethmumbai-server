generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Ticket {
  id       String  @id @default(uuid())
  title    String  @unique
  type     String
  fiat     Float   @default(999)
  crypto   Float   @default(12)
  quantity Int
  orders   Order[]
}

model Order {
  id                 String             @id @default(uuid())  

  // Razorpay fields
  razorpayOrderId    String?            @unique   // Razorpay: order_id
  razorpayPaymentId  String?            @unique   // Razorpay: payment_id
  razorpaySignature  String?            @unique   // Razorpay: signature_id

  // Daimo fields
  daimoPaymentId     String?            @unique   // Daimo: payId
  daimoTxHash        String?            @unique   // Daimo: blockchain transaction hash

  // Common order info
  ticketId           String
  buyerName          String
  buyerEmail         String
  buyerPhone         String
  amount             Float
  currency           String             @default("INR") // INR or CRYPTO (USDC)
  status             String             @default("created") // created, attempted, paid, failed
  paymentType        PaymentType?
  paymentVerified    Boolean            @default(false)

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  buyerEmailSent     Boolean             @default(false)
  buyerEmailSentAt   DateTime?

  // Relations
  ticket             Ticket             @relation(fields: [ticketId], references: [id])
  generatedTickets   GeneratedTicket[]        
  participants       Participant[]
}

model Participant {
  id              String           @id @default(uuid())
  orderId         String
  name            String
  email           String?          @unique
  isBuyer         Boolean          @default(false)
  generatedTicket GeneratedTicket?
  order           Order                 @relation(fields: [orderId], references: [id])

  emailSent       Boolean             @default(false)
  emailSentAt     DateTime?
}

model GeneratedTicket {
  id            String      @id @default(uuid())
  ticketCode    String      @unique
  participantId String      @unique
  orderId       String

  qrHash        String?               
  checkedIn     Boolean                 @default(false)  //for check-in
  checkedInAt   DateTime                @default(now())  //for check-in

  order         Order       @relation(fields: [orderId], references: [id])
  participant   Participant @relation(fields: [participantId], references: [id])
}

enum PaymentType {
  RAZORPAY
  DAIMO
}
